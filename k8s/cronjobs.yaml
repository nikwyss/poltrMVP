apiVersion: batch/v1
kind: CronJob
metadata:
  name: indexer-backfill-nightly
  namespace: poltr
spec:
  schedule: "0 * * * *"
  suspend: false
  concurrencyPolicy: Forbid
  jobTemplate:
    spec:
      backoffLimit: 2
      activeDeadlineSeconds: 50
      ttlSecondsAfterFinished: 86400
      template:
        spec:
          containers:
            - name: backfill-trigger
              image: curlimages/curl:8.2.1
              command: ["sh", "-c"]
              args:
                  - |
                    curl -X POST --fail --show-error \
                      --connect-timeout 10 --max-time 30 \
                      --retry 2 --retry-delay 5 \
                      "http://indexer.poltr.svc.cluster.local/backfill?id=backfill:firehose-missed" \
                      || exit 1
          restartPolicy: Never

# CRONJOB TEST: 
# kubectl run --rm -i --tty curl-test2 -n poltr --image=curlimages/curl --restart=Never -- sh -c "curl -v --connect-timeout 5 --max-time 10 'http://indexer.poltr.svc.cluster.local:3000/backfill?id=backfill:firehose-missed' || echo EXIT:$?"
# EXIT:0